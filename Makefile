# avrtmon
# Makefile
# Uses the rules defined by Prof. Giorgio Grisetti in the file 'avr.mk'
# Paolo Lucchesi - Tue 06 Aug 2019 02:27:30 AM CEST
# Refer to files located under 'resources/gnu-make/' for further informations
.POSIX:
.SUFFIXES: # Reset all implicit rules

# Detect passed target architecture, passed in the ARCH variable (can be passed
# also from the shell).
# Possible values are 'avr' or 'host'. Defaults to 'avr'
ARCH ?= avr

# Codebase directory structure
SRCDIR := sources
INCDIR := include
OBJDIR := objects/$(ARCH)
RESDIR := resources

# The file containing specific rules for an architecture must be located in
# $(RESDIR)/gnu-make/arch-<ARCH>.mk
include $(RESDIR)/gnu-make/arch-$(ARCH).mk

# Search Paths
vpath %.c $(SRCDIR)/$(ARCH)
vpath %.c $(SRCDIR)
vpath %.s $(SRCDIR)/$(ARCH)
vpath %.s $(SRCDIR)
vpath %.o $(OBJDIR)


# TODO: Are BINS and OBJECTS required?
# Executable files containing the 'main' routine (e.g. foo-bin, bar.hex)
BINS := 

# Object files to be generated by GNU Make (e.g. foobar.o)
# Do not prefix the object directory (e.g. foo.o is OK, objects/foo.o is not)
OBJECTS := 


# Objects and binaries recipes

$(OBJDIR)/%.o:	%.c 
	$(CC) $(CFLAGS) -c -o $@ $<

$(OBJDIR)/%.o:	%.s 
	$(AS) $(ASFLAGS) -c -o $@ $<

# Preserve object files to be automatically deleted as intermediate targets
.PRECIOUS: $(OBJDIR)/%.o


all: $(patsubst $(SRCDIR)/%.c, $(OBJDIR)/%.o, $(wildcard $(SRCDIR)/*.c)) $(patsubst $(SRCDIR)/$(ARCH)/%.c, $(OBJDIR)/%.o, $(wildcard $(SRCDIR)/$(ARCH)/*.c))
	make -s config_gen
	$(CC) $(CFLAGS) -o avrtmon_bin $^


# Generate the configuration sources
config_gen:
	resources/bin/config-gen -c $(RESDIR)/config/default.csv -N $(SRCDIR)/avr/nvm.c


# Test (from the PC's OS) a module of the project
# Tests are done by performing:
#   $(call host_test [additional compiler args])
# The function expect to find a source file named 'tests/<test_name>.c'
# You can also choose a test method defining the variable 'TEST_WITH' in your
# shell. Supported option are none (i.e. execute as-is), 'gdb' and 'less'
test_%: CFLAGS := $(TESTFLAGS) $(CFLAGS)

# Generate a mock configuration for testing
define test_config_gen =
	$(RESDIR)/bin/config-gen -c $(RESDIR)/config/test.csv -S tests/config.c \
	  -H tests/include/config.h -N tests/nvm.c
endef

# Remove the mock configuration for testing
define test_config_clean =
	rm tests/{config.c,include/config.h,nvm.c}
endef

test_crc: $(addprefix $(OBJDIR)/, crc.o)
	$(call host_test)

test_packet: $(addprefix $(OBJDIR)/, crc.o packet.o)
	$(call host_test)

test_temperature:
	$(call test_config_gen)
	$(call host_test, $(SRCDIR)/avr/temperature.c tests/mock_nvm.c $(SRCDIR)/nvm.c)
	$(call test_config_clean)

test_config:
	$(call test_config_gen)
	$(call host_test, tests/config.c tests/mock_nvm.c)
	$(call test_config_clean)

test_shell:
	$(call host_test, $(SRCDIR)/host/shell.c)

test_list:
	$(call host_test, $(SRCDIR)/host/list.c)

test_serial: tests/serial_test.hex
	# TODO: Write an automated test for host-side
	# TODO: Provide also 'serial.o' object file

# Perform all tests in a stroke
test: CFLAGS := $(TESTFLAGS) $(CFLAGS)
test:
	@make -s test_crc
	@make -s test_packet
	@make -s test_config
	@make -s test_temperature
	@make -s test_shell
	@make -s test_list

# Standard make PHONY rules
.PHONY:	clean all config_gen

clean:	
	rm -f $(OBJDIR)/../{avr,host}/* $(BINS) tests/bin/* \
	  sources/{config,avr/nvm}.c include/config.h tests/{config.c,include/config.h}

